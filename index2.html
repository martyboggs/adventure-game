<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="style.css">
	<script src="Bomb.js"></script>
	<script src="Guy.js"></script>
	<script src="Building.js"></script>
</head>
<body>

<div class="game">
	<div class="rotate">
		<div class="ground">
			<div class="player"></div>
		</div>
		<div class="translate"></div>
	</div>
</div>

<script>
	var game = document.querySelector('.game');
	var ground = document.querySelector('.ground');
	var player = document.querySelector('.player');
	var translate = document.querySelector('.translate');
	var x, y, r, i, j, k;
	x = y = r = i = j = 0;
	var frame = 0;
	var rotate = document.querySelector('.rotate');
	var turning = 0;
	var moving = 0;
	var r2 = 90;
	var timer = 120;

	document.addEventListener('keydown', function (e) {
		if (e.key === 'ArrowLeft' || e.key === 'a') {
			turning = -1;
		}
		if (e.key === 'ArrowRight' || e.key === 'd') {
			turning = 1;
		}
		if (e.key === 'ArrowUp' || e.key === 'w') {
			moving = 1;
		}
		if (e.key === 'ArrowDown' || e.key === 's') {
			moving = -1;
		}
		if (e.key === 'j') {
			new Bomb(250 - x, 250 - y);
		}
	});

	document.addEventListener('keyup', function (e) {
		if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'a' || e.key === 'd') {
			turning = 0;
		}
		if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'w' || e.key === 's') {
			moving = 0;
		}
	});

	for (i = 0; i < 16; i += 1) {
		new Guy();
	}

	var map = [
		[1, 0, 0 ,0, 0, 1],
		[0, 0, 0 ,0, 0, 0],
		[0, 0, 1 ,0, 0, 0],
		[1, 0, 0 ,0, 0, 0],
		[0, 0, 0 ,1, 0, 0],
		[1, 0, 0 ,0, 0, 1],
	];
	for (i = 0; i < map.length; i += 1) {
		for (var j = 0; j < map[i].length; j += 1) {
			if (map[i][j] === 1) new Building(j * 300, i * 300);
		}
	}

	class Puddle {
		static things = [];
		constructor(x, y) {
			this.constructor.things.push(this);
			this.x = x;
			this.y = y;
			this.el = document.createElement('div');
			this.el.className = 'puddle';
			this.el.style.width = this.el.style.height = '40px';
			this.el.style.background = 'purple';
			this.el.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
			translate.appendChild(this.el);
		}
	}

	function update() {
		if (turning === -1) r -= 1;
		else if (turning === 1) r += 1;
		if (moving === -1) {
			x += k * Math.cos((r - 90) * Math.PI / 180);
			y += k * Math.sin((r - 90) * Math.PI / 180);
		} else if (moving === 1) {
			x -= k * Math.cos((r - 90) * Math.PI / 180);
			y -= k * Math.sin((r - 90) * Math.PI / 180);
		}
		rotate.style.transform = `rotateY(${r}deg)`;
		player.style.transform = `translate3d(-50%, -50%, 26px) rotateX(-90deg) rotateY(${-r}deg)`;
		translate.style.transform = `rotateX(${r2}deg) translate3d(calc(-50% + ${x}px), ${y}px, 0)`;
		ground.style.transform = `rotateX(${r2}deg) translateX(-50%)`;
		for (i = 0; i < Guy.things.length; i += 1) {
			Guy.things[i].update();
		}
		for (i = 0; i < Building.things.length; i += 1) {
			Building.things[i].update();
		}
		for (i = 0; i < Bomb.things.length; i += 1) {
			Bomb.things[i].update();
		}
		for (i = 0; i < Shrapnel.things.length; i += 1) {
			Shrapnel.things[i].update();
		}
		k = 2 * Math.sin(frame * 0.01) + 4;
		frame += 1;
	}

	var uiValue;

	setInterval(function () {
		update();
	}, 10);

</script>

</body>
</html>