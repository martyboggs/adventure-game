<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="style.css">
	<script src="Bomb.js"></script>
	<script src="Guy.js"></script>
	<script src="Building.js"></script>
	<script src="Drone.js"></script>
</head>
<body>

<div class="game">
	<div class="ui">
		<div class="power"></div>
	</div>
	<div class="rotate">
		<div class="ground">
			<div class="player"></div>
		</div>
		<div class="translate"></div>
	</div>
</div>

<script>
	// top left is 0,0
	// angle 0 is straight ahead
	var game = document.querySelector('.game');
	var ground = document.querySelector('.ground');
	var player = document.querySelector('.player');
	var translate = document.querySelector('.translate');
	var power = document.querySelector('.power');
	var x, y, i, j, k;
	x = y = i = j = k = 0;
	var frame = 0;
	var rotate = document.querySelector('.rotate');
	var turning = 0;
	var moving = 0;
	var angle = 0;
	var r2 = 90;
	var timer = 120;
	var level = 0;
	var drone;
	var speed;

	document.addEventListener('keydown', function (e) {
		if (e.key === 'a') {
			turning = -1;
		}
		if (e.key === 'd') {
			turning = 1;
		}
		if (e.key === 'w') {
			moving = 1;
		}
		if (e.key === 's') {
			moving = -1;
		}
		if (drone && e.key === 'ArrowLeft') {
			drone.strafe = -1;
		}
		if (drone && e.key === 'ArrowRight') {
			drone.strafe = 1;
		}
		if (drone && e.key === 'ArrowUp') {
			drone.moving = 1;
		}
		if (drone && e.key === 'ArrowDown') {
			drone.moving = -1;
		}
		if (e.key === 'j') {
			// for (var i = 0; i < 10; i += 1) {
			// 	new Bomb(250 + x, 250 + y);
			// }
			// if (!drone) drone = new Drone(250 + x, 250 + y);
			new Bomb(250 + x, 250 + y);
		}
	});

	document.addEventListener('keyup', function (e) {
		if (e.key === 'a' || e.key === 'd') {
			turning = 0;
		}
		if (e.key === 'w' || e.key === 's') {
			moving = 0;
		}
	});

	document.addEventListener('keyup', function (e) {
		if (!drone) return;
		if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
			drone.strafe = 0;
		}
		if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
			drone.moving = 0;
		}
	});

	for (i = 0; i < 2; i += 1) {
		new Guy(Math.floor(Math.random() * 500), Math.floor(Math.random() * 500));
	}

	var map = [
		[1, 0, 0 ,0, 0, 1],
		[0, 0, 0 ,0, 0, 0],
		[0, 0, 1 ,0, 0, 0],
		[1, 0, 0 ,0, 0, 0],
		[0, 0, 0 ,1, 0, 0],
		[1, 0, 0 ,0, 0, 1],
	];
	for (i = 0; i < map.length; i += 1) {
		for (var j = 0; j < map[i].length; j += 1) {
			if (map[i][j] === 1) new Building(j * 300, i * 300);
		}
	}

	function update() {
		if (turning === -1) angle -= 1;
		else if (turning === 1) angle += 1;
		if (moving === 1) {
			x += speed * Math.sin(angle * Math.PI / 180);
			y -= speed * Math.cos(angle * Math.PI / 180);
		} else if (moving === -1) {
			x -= speed * Math.sin(angle * Math.PI / 180);
			y += speed * Math.cos(angle * Math.PI / 180);
		} 
		rotate.style.transform = `rotateY(${angle}deg)`;
		player.style.transform = `translate3d(-50%, -50%, 26px) rotateX(-90deg) rotateY(${-angle}deg)`;
		translate.style.transform = `rotateX(${r2}deg) translate3d(calc(-50% + ${-x}px), ${-y}px, 0)`;
		ground.style.transform = `rotateX(${r2}deg) translateX(-50%)`;
		for (i = 0; i < Guy.things.length; i += 1) {
			Guy.things[i].update();
		}
		for (i = 0; i < Building.things.length; i += 1) {
			Building.things[i].update();
		}
		for (i = 0; i < Bomb.things.length; i += 1) {
			Bomb.things[i].update();
		}
		for (i = 0; i < Shrapnel.things.length; i += 1) {
			Shrapnel.things[i].update();
		}
		if (drone) drone.update();
		speed = 2 * Math.sin(frame * 0.01) + 4; // variable speed
		power.innerHTML = Math.floor(timer);
		timer -= 0.01;
		frame += 1;
	}

	setInterval(function () {
		update();
	}, 10);

</script>

</body>
</html>